# 人体の急所学習アプリケーション 仕様書

## 1. 概要

人体の急所70箇所の名前を覚えるための学習アプリケーションです。画像を使った4択クイズ形式で学習し、学習履歴を永続的に保存します。

## 2. 主要機能

### 2.1 学習モード

#### 2.1.1 通常モード
- 全70箇所の急所をランダムな順序で出題
- 画像に表示された急所の番号を見て、その名前を4択から選択
- 正解: 次の問題へ進む
- 不正解: 正解を表示し、同じ問題を再出題

#### 2.1.2 苦手な問題モード
- 不正解が多い順に優先的に出題
- 不正解履歴がある場合のみ選択可能
- 不正解が多い急所を集中的に学習できる

### 2.2 問題表示形式

表示順序:
1. 問題文（例: 「この急所「①」の名前は？」）
2. 選択肢（4つ、ふりがな付き）
3. 急所の画像

### 2.3 学習履歴の管理

#### 2.3.1 記録内容
- 各急所ごとの正解回数
- 各急所ごとの不正解回数
- 最終学習日時
- 正解率の自動計算

#### 2.3.2 永続性
- SQLiteデータベースに永続的に保存
- サーバー再起動やデータ更新後も履歴を保持
- ブラウザのリフレッシュでも履歴は消えない

### 2.4 統計表示

#### 2.4.1 スタート画面の統計サマリ
- 累計正解数
- 累計不正解数
- 全体の正解率

#### 2.4.2 詳細統計画面
- 各急所ごとの学習履歴
- 急所別の正解率
- 苦手な急所の把握

### 2.5 セッション管理

- 問題セッションの一時保存
- 中断・再開機能（現在の実装では完全終了まで継続）
- セッション完了時に学習履歴を更新

## 3. 技術仕様

### 3.1 技術スタック

#### フロントエンド
- React.js 18.x
- Vite 5.4.21（ビルドツール）
- Axios（HTTP通信）
- CSS（スタイリング）

#### バックエンド
- Django 5.0
- Django REST Framework
- django-cors-headers
- Pillow（画像処理）

#### データベース
- SQLite 3

#### 開発環境
- Node.js 18.20.8
- Python 3.12
- Git（バージョン管理）

### 3.2 ディレクトリ構造

```
vital_points/
├── backend/
│   ├── backend/
│   │   ├── settings.py       # Django設定
│   │   ├── urls.py            # URLルーティング
│   │   └── ...
│   ├── quiz/
│   │   ├── models.py          # データモデル
│   │   ├── views.py           # APIビュー
│   │   ├── serializers.py     # シリアライザ
│   │   ├── management/
│   │   │   └── commands/
│   │   │       └── load_vital_points.py
│   │   └── ...
│   ├── manage.py
│   └── db.sqlite3
├── frontend/
│   ├── src/
│   │   ├── App.jsx            # メインアプリ
│   │   ├── App.css
│   │   ├── components/
│   │   │   ├── StartScreen.jsx      # スタート画面
│   │   │   ├── QuizView.jsx         # クイズ画面
│   │   │   └── Statistics.jsx       # 統計画面
│   │   └── api/
│   │       └── client.js            # APIクライアント
│   ├── public/
│   │   └── images/            # 急所画像
│   └── package.json
├── venv/                      # Python仮想環境
├── images/                    # 元画像（加工前）
├── vital_points_master.json   # 急所マスターデータ
├── vital_points_edit.txt      # 編集用テキストデータ
├── convert_edited_data.py     # データ変換スクリプト
├── crop_images.py             # 画像切り取りスクリプト
└── docs/                      # ドキュメント
    ├── SPECIFICATION.md       # 本仕様書
    ├── API.md                 # API仕様書
    └── SETUP.md               # セットアップガイド
```

### 3.3 データモデル

#### VitalPoint（急所マスター）
| フィールド | 型 | 説明 |
|----------|-----|------|
| id | Integer | 主キー（自動採番） |
| number | String | 画像内の番号（①、②など） |
| name | String | 急所の名前 |
| reading | String | ふりがな |
| category | String | カテゴリ（頭部、上肢、胴部、下肢前、下肢後） |
| image_file | String | 画像ファイル名 |

**ユニークキー**: (image_file, number, name)

#### LearningHistory（学習履歴）
| フィールド | 型 | 説明 |
|----------|-----|------|
| id | Integer | 主キー（自動採番） |
| vital_point | ForeignKey | VitalPointへの参照（OneToOne） |
| correct_count | Integer | 正解回数 |
| incorrect_count | Integer | 不正解回数 |
| last_learned_at | DateTime | 最終学習日時 |

**計算フィールド**:
- accuracy_rate: 正解率（正解数 / 総回答数 × 100）

#### QuizSession（クイズセッション）
| フィールド | 型 | 説明 |
|----------|-----|------|
| id | Integer | 主キー（自動採番） |
| status | String | ステータス（active/paused/completed） |
| current_question_order | Integer | 現在の問題番号 |
| created_at | DateTime | 作成日時 |
| updated_at | DateTime | 更新日時 |

#### SessionQuestion（セッション内の問題）
| フィールド | 型 | 説明 |
|----------|-----|------|
| id | Integer | 主キー（自動採番） |
| session | ForeignKey | QuizSessionへの参照 |
| vital_point | ForeignKey | VitalPointへの参照 |
| question_order | Integer | 問題の順序 |
| is_answered | Boolean | 回答済みフラグ |
| is_correct | Boolean | 正解フラグ |

### 3.4 急所データ

#### データ構成
- **画像1（頭部）**: 22箇所（① ~ ㉒）
- **画像2（上肢）**: 15箇所（内側①~⑦、外側①~⑧）
- **画像3（胴部）**: 12箇所（① ~ ⑫）
- **画像4（下肢前）**: 12箇所（① ~ ⑫）
- **画像5（下肢後）**: 9箇所（⑬ ~ ㉑）

**合計**: 70箇所

#### 重複する名前
- **三里**: 画像2（上肢③）と画像4（下肢⑧）に存在
  - 選択肢生成時は同じ名前を除外して重複を防止

## 4. 機能詳細

### 4.1 選択肢生成ロジック

1. 正解の急所を1つ選択
2. 正解と**異なるIDかつ異なる名前**の急所からランダムに3つ選択
3. 合計4つの選択肢をシャッフル
4. 各選択肢に名前とふりがなを表示

### 4.2 苦手な問題モードのロジック

1. 学習履歴から`incorrect_count > 0`の急所を取得
2. `incorrect_count`の降順（多い順）でソート
3. 不正解が多い急所を優先的に配置
4. 残りの急所（不正解0または未学習）をランダムに追加
5. この順序でセッションを作成

### 4.3 学習履歴の更新

#### 正解時
```python
history.correct_count += 1
history.last_learned_at = timezone.now()
history.save()
```

#### 不正解時
```python
history.incorrect_count += 1
history.last_learned_at = timezone.now()
history.save()
```

### 4.4 データ更新時の履歴保持

`load_vital_points`コマンドは`update_or_create()`を使用:
- 既存データ: 名前やふりがなを更新（IDは変更なし）
- 新規データ: 新しいレコードを作成
- VitalPointのIDが保持されるため、LearningHistoryとの関連も維持

## 5. 画像処理

### 5.1 画像の加工

元画像から正解部分をカットして使用:

#### crop_images.py の設定
```python
crop_settings = {
    'Scan2025-12-13_140703_000.png': {  # 画像1（頭部）
        'top': 1.0, 'bottom': 0.5, 'left': 1.0, 'right': 1.0
    },
    'Scan2025-12-13_140703_001.png': {  # 画像2（上肢）
        'top': 1.0, 'bottom': 0.5, 'left': 1.0, 'right': 1.0
    },
    'Scan2025-12-13_140703_002.png': {  # 画像3（胴部）
        'top': 1.0, 'bottom': 0.45, 'left': 1.0, 'right': 1.0
    },
    'Scan2025-12-13_140703_003.png': {  # 画像4（下肢前）
        'top': 1.0, 'bottom': 1.0, 'left': 1.0, 'right': 0.55
    },
    'Scan2025-12-13_140703_004.png': {  # 画像5（下肢後）
        'top': 1.0, 'bottom': 1.0, 'left': 1.0, 'right': 0.55
    },
}
```

- 画像1-3: 下部の正解表をカット（bottom < 1.0）
- 画像4-5: 右側の正解表をカット（right < 1.0）

### 5.2 画像の配置

加工済み画像は`frontend/public/images/`に配置し、フロントエンドから直接参照。

## 6. UI/UX仕様

### 6.1 カラースキーム

- **プライマリ**: グラデーション（#667eea → #764ba2）
- **セカンダリ**: グレー（#f0f0f0）
- **警告/苦手**: オレンジグラデーション（#ffa726 → #fb8c00）
- **正解**: グリーン（#28a745）
- **不正解**: レッド（#dc3545）

### 6.2 レスポンシブデザイン

- 最大幅1200px、中央寄せ
- カードベースのUIデザイン
- ボタンはホバーで浮き上がるアニメーション

### 6.3 問題表示のレイアウト

```
┌─────────────────────────────┐
│ この急所「①」の名前は？      │  ← 問題文
├─────────────────────────────┤
│ [選択肢1] 名前（ふりがな）   │  ← 選択肢
│ [選択肢2] 名前（ふりがな）   │
│ [選択肢3] 名前（ふりがな）   │
│ [選択肢4] 名前（ふりがな）   │
├─────────────────────────────┤
│                             │
│     [急所の画像]             │  ← 画像
│                             │
└─────────────────────────────┘
```

### 6.4 回答後の表示

- 正解: 選択肢が緑色にハイライト
- 不正解: 選択した選択肢が赤色、正解が緑色にハイライト
- 「次の問題へ」「学習を終える」ボタンを表示
- 自動遷移なし（ユーザーが明示的にボタンを押す）

## 7. API通信仕様

詳細は`API.md`を参照。

### 7.1 主要エンドポイント

- `POST /api/quiz-sessions/start_new_session/` - セッション開始
- `GET /api/quiz-sessions/{id}/current_question/` - 現在の問題取得
- `POST /api/quiz-sessions/{id}/submit_answer/` - 回答送信
- `GET /api/learning-history/statistics/` - 統計情報取得

## 8. セキュリティ

### 8.1 CORS設定

開発環境では以下のオリジンを許可:
- `http://localhost:3000`
- `http://localhost:5173`

### 8.2 認証

現在は単一ユーザー想定のため、認証機能なし。

## 9. 今後の拡張可能性

- ユーザー認証・マルチユーザー対応
- 学習進捗のグラフ表示
- 学習時間の記録
- 復習スケジュールの自動提案
- モバイルアプリ化
- 音声読み上げ機能

## 10. 制約事項

- 単一ユーザーのみ対応
- オフライン動作非対応
- 画像は静的ファイルとして配信（CDN未使用）
- ブラウザはモダンブラウザのみ対応（ES6+）

## 11. バージョン履歴

- v1.0.0 (2025-12-14): 初回リリース
  - 全70箇所の急所データ登録
  - 通常モードと苦手な問題モードの実装
  - 学習履歴の永続化
  - 選択肢重複問題の修正
